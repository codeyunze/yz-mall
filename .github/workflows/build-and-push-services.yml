name: Build and Push Service Images

on:
  workflow_dispatch:          # 手动触发
  push:                       # 可选：推送到 main 分支时自动构建
    branches:
      - main
    paths:
      - 'mall-*/**'
      - '.github/workflows/build-and-push-services.yml'

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # 通过仓库 Variables 控制“需要构建镜像的启动模块”列表
        # 仅列表中的模块会构建并推送镜像；其依赖的工具包仅参与 Maven 打包，不单独出镜像。
        # Settings -> Secrets and variables -> Actions -> Variables:
        #   DOCKER_SERVICES_JSON, 如: ["mall-gateway","mall-sys-startup","mall-oms-startup"]
        service: ${{ fromJSON(vars.DOCKER_SERVICES_JSON || '["mall-gateway"]') }}

    env:
      REGISTRY: registry.cn-guangzhou.aliyuncs.com
      NAMESPACE: devyunze

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Build ${{ matrix.service }} jar with Maven (deps only used as libraries)
        run: |
          mvn -B -DskipTests=true -pl ${{ matrix.service }} -am package

      - name: Login to Alibaba Cloud Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.ALIYUN_REGISTRY_USERNAME }}
          password: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          build-args: |
            APP_MODULE=${{ matrix.service }}
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ matrix.service }}:latest
            ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ matrix.service }}:${{ github.sha }}
