# 网关认证迁移方案

## 概述

将认证和权限校验从业务服务（mall-sys、mall-oms等）迁移到网关层（mall-gateway），实现统一认证，减轻业务服务处理压力。

## 架构变化

### 迁移前
```
客户端 -> 网关 -> 业务服务（认证+权限校验）-> 业务逻辑
```

### 迁移后
```
客户端 -> 网关（认证+权限校验）-> 业务服务（业务逻辑）
```

## 实现内容

### 1. 网关层实现

#### 1.1 依赖添加
- `sa-token-reactor-spring-boot-starter` - Sa-Token 响应式集成
- `sa-token-redis-jackson` - Sa-Token Redis 集成
- `mall-redis` - Redis 工具模块
- `mall-auth-interface` - 认证接口模块

#### 1.2 核心组件

**AuthenticationGatewayFilter** - 认证过滤器
- 检查请求是否在白名单中
- 验证用户登录状态（token 有效性）
- 将用户ID传递给下游服务

**PermissionGatewayFilter** - 权限校验过滤器
- 根据请求路径获取所需权限
- 检查用户是否拥有该权限
- 权限校验失败返回 403

**GatewayPermissionService** - 权限服务
- 从 Redis 获取用户权限列表
- 根据路径推断或匹配所需权限标识
- 支持路径权限映射缓存

**GatewayAuthProperties** - 配置属性
- 白名单路径配置
- 认证开关配置

### 2. 配置说明

#### 2.1 application.yaml 配置

```yaml
# Sa-Token 配置
sa-token:
  token-name: Authorization
  timeout: 2592000
  is-read-head: true
  token-prefix: Bearer

# 网关认证配置
gateway:
  auth:
    enabled: true
    white-list:
      - /authentication/login
      - /authentication/register
      - /actuator/**
      # ... 其他白名单路径
```

#### 2.2 白名单路径

以下路径默认不需要认证：
- `/authentication/login` - 登录接口
- `/authentication/register` - 注册接口
- `/authentication/refreshToken` - 刷新token接口
- `/actuator/**` - 健康检查接口
- `/error/**` - 错误页面
- `/beat`, `/idleBeat`, `/kill`, `/run`, `/log` - XXL-Job 接口
- `/sys/test/**`, `/extend/**` - 测试接口

### 3. 权限标识规则

网关层通过路径推断权限标识，规则如下：

```
路径: /sys/dictionary/add
权限标识: api:system:dictionary:update

路径: /sys/user/page
权限标识: api:system:user:query
```

操作映射规则：
- `add`, `update`, `delete` -> `update`
- `get`, `page`, `list` -> `query`

### 4. 业务服务改造

#### 4.1 移除认证拦截器

在业务服务中，需要移除或禁用 `SaTokenConfigure` 中的登录校验：

```java
// 方式1：完全移除 SaTokenConfigure 配置类
// 方式2：注释掉拦截器注册代码
// 方式3：添加条件注解，在网关环境下禁用
@ConditionalOnProperty(name = "gateway.auth.enabled", havingValue = "false", matchIfMissing = true)
```

#### 4.2 保留权限注解（可选）

如果业务服务仍需要保留 `@SaCheckPermission` 注解用于文档或二次校验，可以保留，但网关层已经进行了权限校验。

#### 4.3 获取用户信息

业务服务可以通过请求头获取用户ID：

```java
@RequestHeader(value = "X-User-Id", required = false) String userId
```

## 迁移步骤

### 步骤1：部署网关认证功能
1. 更新网关代码
2. 配置 Redis 连接
3. 配置 Sa-Token
4. 测试网关认证功能

### 步骤2：灰度验证
1. 选择一个业务服务进行测试（如 mall-sys）
2. 在业务服务中禁用认证拦截器
3. 验证认证和权限校验是否正常工作
4. 观察日志和性能指标

### 步骤3：全量迁移
1. 逐步迁移其他业务服务
2. 移除业务服务中的认证拦截器
3. 更新相关文档

### 步骤4：优化和监控
1. 优化权限匹配性能
2. 添加权限映射配置（如需要）
3. 监控认证失败率和性能指标

## 注意事项

### 1. 权限标识匹配
- 网关层通过路径推断权限标识，可能与实际权限标识不完全一致
- 建议在配置中心维护路径-权限映射关系
- 或通过接口扫描自动生成权限映射

### 2. 性能考虑
- 权限校验会增加网关响应时间
- 建议对权限信息进行缓存
- 考虑使用本地缓存（Caffeine）提升性能

### 3. 兼容性
- 确保网关和业务服务使用相同的 Sa-Token 配置
- Token 存储方式（Redis）需要保持一致
- 权限标识命名规范需要统一

### 4. 异常处理
- 认证失败返回 401
- 权限校验失败返回 403
- 统一错误响应格式

## 回滚方案

如果迁移后出现问题，可以快速回滚：

1. **网关层回滚**：在配置中设置 `gateway.auth.enabled=false` 禁用网关认证
2. **业务服务恢复**：重新启用业务服务中的 `SaTokenConfigure` 拦截器

## 测试验证

### 1. 认证测试
- [ ] 未登录请求返回 401
- [ ] 已登录请求正常通过
- [ ] Token 过期返回 401
- [ ] 白名单路径不需要认证

### 2. 权限测试
- [ ] 有权限的接口正常访问
- [ ] 无权限的接口返回 403
- [ ] 路径权限匹配正确

### 3. 性能测试
- [ ] 认证响应时间 < 10ms
- [ ] 权限校验响应时间 < 5ms
- [ ] 高并发场景下性能稳定

## 后续优化

1. **权限映射配置化**：从数据库或配置中心加载路径-权限映射
2. **权限缓存优化**：使用多级缓存提升性能
3. **权限审计**：记录权限校验日志，便于问题排查
4. **动态权限更新**：支持权限变更后实时生效

