# 电商系统实现规划（概要版）

## 一、系统架构概览

### 1.1 现有基础
- ✅ **后台管理系统** (mall-admin)：系统管理、权限管理、数据字典等
- ✅ **认证授权服务** (mall-auth)：用户认证、权限验证
- ✅ **网关服务** (mall-gateway)：统一入口、路由转发
- ✅ **商品库存模块** (mall-pms)：商品管理、库存管理（基础功能）
- ✅ **订单管理模块** (mall-oms)：订单创建、查询、取消（基础功能）
- ✅ **基础设施**：Nacos、Seata、RocketMQ、Redis、MySQL

### 1.2 需要新增/完善的子系统
- 🔨 **产品系统** (mall-pms 扩展)：商品分类、品牌、属性、规格、SKU管理
- 🔨 **库存系统** (mall-pms 扩展)：库存锁定、扣减、预警、出入库记录
- 🔨 **订单系统** (mall-oms 扩展)：订单流程、假支付、订单状态流转
- 🔨 **用户系统** (mall-ums)：用户注册登录、用户信息、收货地址
- 🔨 **购物车系统** (mall-cart)：购物车管理、结算
- 🔨 **支付系统** (mall-pay)：假支付实现、支付接口预留（后续扩展真实支付）
- 🔨 **供应链系统** (mall-scm)：供应商管理、采购管理（后续扩展）
- 🔨 **营销系统** (mall-sms)：优惠券、促销活动（后续扩展）
- 🔨 **物流系统** (mall-logistics)：物流对接、配送管理（后续扩展）

---

## 二、实现步骤（分阶段）

### 第一阶段：核心购物功能（MVP 最小可行产品）
**目标**：实现基本的商品购物交易闭环（PC端）

#### 1.1 产品系统完善（mall-pms 扩展）
- 商品分类管理（多级分类）
- 商品品牌管理
- 商品属性管理（规格、参数）
- SKU管理（多规格商品）
- 商品上下架流程完善
- 商品搜索（Elasticsearch集成）
- 商品详情页展示

#### 1.2 库存系统完善（mall-pms 扩展）
- 库存锁定机制（下单锁定，支付扣减）
- 库存扣减逻辑
- 库存预警（低库存提醒）
- 库存出入库记录
- 库存查询优化

#### 1.3 用户系统（mall-ums 新建）
- 用户注册/登录（对接mall-auth）
- 用户信息管理
- 收货地址管理（增删改查）
- 用户中心基础功能

#### 1.4 购物车系统（mall-cart 新建）
- 购物车增删改查
- 购物车商品数量修改
- 购物车结算
- 购物车持久化（Redis + 数据库）

#### 1.5 订单系统完善（mall-oms 扩展）
- 订单创建（从购物车结算）
- 订单状态流转（待付款→待发货→已发货→已完成）
- 订单超时自动取消（定时任务）
- 订单详情查询
- 订单列表查询（用户端、管理端）
- 订单取消功能

#### 1.6 支付系统（mall-pay 新建）
- 假支付实现（模拟支付成功）
- 支付接口预留（定义支付接口规范，便于后续接入真实支付）
- 支付状态更新
- 支付回调处理（预留接口）

**预计时间**：6-8周

---

### 第二阶段：系统优化与扩展准备
**目标**：优化核心功能，为后续扩展做准备

#### 2.1 订单系统优化
- 订单查询性能优化
- 订单状态流转优化
- 订单统计（基础统计）

#### 2.2 库存系统优化
- 库存查询性能优化
- 库存预警优化
- 库存统计报表

#### 2.3 产品系统优化
- 商品搜索性能优化
- 商品详情页缓存优化
- 商品统计（热销商品等）

#### 2.4 系统性能优化
- Redis缓存优化
- 数据库查询优化
- 接口响应时间优化

**预计时间**：2-3周

---

### 第三阶段：后续扩展功能（待定）
**目标**：根据业务需求逐步扩展

#### 3.1 订单系统扩展
- 订单拆分（按仓库/供应商）
- 订单合并
- 订单售后（退货、换货）
- 订单评价

#### 3.2 库存系统扩展
- 多仓库管理
- 库存分配策略
- 库存盘点功能
- 库存调拨

#### 3.3 供应链系统（mall-scm 新建）
- 供应商管理（供应商信息、资质、评级）
- 采购管理（采购计划、采购订单、采购入库）
- 供应商对账
- 采购价格管理

#### 3.4 营销系统（mall-sms 新建）
- 优惠券管理（发放、使用、核销）
- 促销活动（满减、折扣）
- 积分系统
- 会员等级体系

#### 3.5 物流系统（mall-logistics 新建）
- 物流公司对接（顺丰、圆通、中通等）
- 物流单号生成
- 物流跟踪（物流状态同步）
- 运费计算（按重量、体积、地区）
- 发货管理

#### 3.6 支付系统扩展
- 真实支付集成（支付宝、微信）
- 支付回调处理
- 退款功能
- 支付对账

#### 3.7 数据分析
- 订单统计（销售额、订单量、转化率）
- 商品统计（热销商品、库存周转）
- 用户统计（用户画像、复购率）
- 财务报表

#### 3.8 移动端
- 小程序开发
- APP开发

#### 3.9 国际化
- 多语言支持
- 多币种支持

**预计时间**：根据业务需求确定

---

## 三、功能开发优先级

### P0（最高优先级 - 第一阶段必须实现）
1. **产品系统完善**：商品分类、SKU管理、商品搜索、商品详情
2. **库存系统完善**：库存锁定、扣减、预警、出入库记录
3. **用户系统**：用户注册登录、用户信息、收货地址管理
4. **购物车系统**：购物车增删改查、结算功能
5. **订单系统完善**：订单创建、订单状态流转、订单查询、订单取消、超时自动取消
6. **支付系统（假支付）**：假支付实现、支付接口预留

### P1（高优先级 - 第二阶段优化）
1. **系统性能优化**：缓存优化、数据库优化、接口优化
2. **基础统计**：订单统计、商品统计、库存统计

### P2（中优先级 - 后续扩展功能）
1. **订单系统扩展**：订单拆分、订单合并、订单售后、订单评价
2. **库存系统扩展**：多仓库管理、库存盘点、库存调拨
3. **营销系统**：优惠券、促销活动、积分系统、会员等级
4. **物流系统**：物流对接、运费计算、发货管理、物流跟踪
5. **供应链系统**：供应商管理、采购管理、供应商对账

### P3（低优先级 - 长期规划）
1. **支付系统扩展**：真实支付集成（支付宝、微信）、退款、对账
2. **数据分析**：BI报表、数据大屏、用户画像
3. **高级营销**：秒杀、拼团、砍价
4. **移动端**：小程序、APP
5. **国际化**：多语言、多币种

---

## 四、技术实现要点

### 4.1 微服务拆分原则
- 按业务领域拆分（产品、订单、库存、用户等）
- 每个服务独立数据库
- 服务间通过Feign调用
- 使用Seata保证分布式事务

### 4.2 数据一致性
- 订单创建：使用Seata分布式事务（订单+库存扣减）
- 假支付处理：同步更新订单状态（后续真实支付改为异步消息队列）
- 库存扣减：使用Redis分布式锁防止超卖

### 4.3 高并发处理
- 商品详情：Redis缓存 + Caffeine本地缓存
- 库存扣减：Redis + 数据库双重校验
- 订单创建：异步处理 + 消息队列削峰

### 4.4 服务端口规划
| 服务 | 端口 | 说明 | 优先级 |
|------|------|------|--------|
| mall-gateway | 30001 | 网关服务 | ✅ 已有 |
| mall-sys | 30004 | 系统管理 | ✅ 已有 |
| mall-pms | 30005 | 商品库存 | ✅ 已有（需扩展） |
| mall-oms | 30006 | 订单管理 | ✅ 已有（需扩展） |
| mall-ums | 30010 | 用户服务 | 🔨 第一阶段新建 |
| mall-cart | 30011 | 购物车服务 | 🔨 第一阶段新建 |
| mall-pay | 30012 | 支付服务（假支付） | 🔨 第一阶段新建 |
| mall-sms | 30013 | 营销服务 | ⏸️ 后续扩展 |
| mall-scm | 30014 | 供应链服务 | ⏸️ 后续扩展 |
| mall-logistics | 30015 | 物流服务 | ⏸️ 后续扩展 |

---

## 五、数据库设计原则

### 5.1 数据库设计
- **单库单表**：第一阶段先不考虑分库分表，使用单库单表设计
- **表结构设计**：预留扩展字段，便于后续分库分表改造
- **索引优化**：合理设计索引，保证查询性能
- **字段规范**：统一字段命名、类型、长度规范

### 5.2 数据同步
- 使用Canal监听MySQL binlog（可选，后续扩展）
- 同步到Elasticsearch（商品搜索）
- 同步到Redis（热点数据缓存）

### 5.3 分库分表规划（后续扩展）
- **订单表**：按订单号分表（时间维度）
- **用户表**：按用户ID分表（用户ID取模）
- **商品表**：按商品ID分表（商品ID取模）
- **实施时机**：当单表数据量达到一定规模（如1000万+）时再考虑分库分表

---

## 六、风险与挑战

### 6.1 技术风险
- **分布式事务**：Seata性能开销，考虑最终一致性方案
- **库存超卖**：Redis + 数据库双重校验，必要时使用分布式锁
- **高并发**：限流、降级、熔断机制

### 6.2 业务风险
- **订单超时**：定时任务自动取消未支付订单
- **库存不足**：下单时校验，假支付时再次校验（后续真实支付时同样需要校验）
- **假支付处理**：确保支付状态更新的幂等性，防止重复处理
- **库存超卖**：Redis + 数据库双重校验，使用分布式锁

---

## 七、开发重点说明

### 7.1 支付系统设计
- **假支付实现**：模拟支付成功，直接更新订单状态为"已支付"
- **接口预留**：定义统一的支付接口规范（IPaymentService），便于后续接入真实支付
- **支付方式枚举**：预留支付方式枚举（支付宝、微信等），当前仅实现"假支付"
- **支付回调**：预留支付回调接口，当前假支付可同步处理，后续真实支付改为异步回调

### 7.2 订单流程设计
- **订单状态**：待付款 → 已付款 → 待发货 → 已发货 → 已完成
- **订单取消**：仅支持"待付款"状态取消，取消后释放库存
- **订单超时**：定时任务扫描"待付款"订单，超时自动取消（默认30分钟）

### 7.3 库存管理设计
- **单仓库**：第一阶段仅支持单仓库，后续扩展多仓库
- **库存锁定**：下单时锁定库存，支付成功后扣减，取消订单释放
- **库存预警**：库存低于阈值时预警提醒

### 7.4 技术选型说明
- **分库分表**：第一阶段不考虑，使用单库单表，后续根据数据量再考虑
- **Elasticsearch**：商品搜索使用，提升搜索性能
- **Redis**：缓存热点数据（商品详情、库存信息等）
- **RocketMQ**：后续真实支付时用于异步处理支付回调

---

## 八、下一步行动

1. **确认规划**：确认本概要规划是否符合预期
2. **详细设计**：针对第一阶段功能进行详细设计
   - 数据库表结构设计
   - API接口设计
   - 业务流程设计
3. **开发实施**：按优先级逐步开发
   - 第一阶段：核心购物功能（6-8周）
   - 第二阶段：系统优化（2-3周）
   - 后续阶段：根据业务需求扩展

---

**说明**：
- 本规划聚焦PC端核心购物功能，暂不考虑移动端和国际化
- 支付系统采用假支付实现，预留真实支付接口
- 订单拆分、售后、评价、多仓库、库存盘点、营销、物流等功能作为后续扩展点
- 分库分表暂不考虑，先实现核心功能，后续根据数据量再优化

