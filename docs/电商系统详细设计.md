# 电商系统详细设计文档

## 一、后台管理系统 (mall-admin)

### 1.1 功能模块

#### 1.1.1 系统管理
- 菜单管理：菜单的增删改查、菜单树形结构展示
- 角色管理：角色的增删改查、角色权限分配
- 用户管理：系统用户的增删改查、用户角色分配
- 权限管理：权限点的管理、权限与菜单关联
- 数据字典管理：字典分类、字典项管理、字典树形结构

#### 1.1.2 系统配置
- 系统参数配置：系统基础参数设置
- 操作日志：用户操作日志记录与查询
- 登录日志：用户登录日志记录与查询

### 1.2 数据流转流程

#### 1.2.1 权限管理流程
```
用户登录 → 认证服务验证 → 获取用户角色 → 获取角色权限 → 返回权限列表 → 前端菜单渲染
```

#### 1.2.2 数据字典管理流程
```
创建字典分类 → 创建字典项 → 构建树形结构 → 缓存字典数据 → 前端使用
```

### 1.3 数据库表设计

#### sys_menu (菜单表)
- id: 主键
- parent_id: 父菜单ID
- menu_name: 菜单名称
- menu_type: 菜单类型（目录/菜单/按钮）
- path: 路由路径
- component: 组件路径
- perms: 权限标识
- sort_order: 排序
- status: 状态

#### sys_role (角色表)
- id: 主键
- role_name: 角色名称
- role_code: 角色编码
- description: 描述
- status: 状态

#### sys_user (系统用户表)
- id: 主键
- username: 用户名
- password: 密码
- nickname: 昵称
- phone: 手机号
- email: 邮箱
- status: 状态

#### sys_role_menu (角色菜单关联表)
- id: 主键
- role_id: 角色ID
- menu_id: 菜单ID

#### sys_user_role (用户角色关联表)
- id: 主键
- user_id: 用户ID
- role_id: 角色ID

#### sys_dictionary (数据字典表)
- id: 主键
- parent_id: 父字典ID
- dictionary_key: 字典键
- dictionary_value: 字典值
- ancestor_id: 祖先ID
- sort_order: 排序
- status: 状态

### 1.4 接口设计

#### 菜单管理
- `POST /sys/menu/add` - 新增菜单
- `POST /sys/menu/update` - 更新菜单
- `DELETE /sys/menu/delete/{id}` - 删除菜单
- `POST /sys/menu/page` - 分页查询菜单
- `GET /sys/menu/tree` - 获取菜单树

#### 角色管理
- `POST /sys/role/add` - 新增角色
- `POST /sys/role/update` - 更新角色
- `DELETE /sys/role/delete/{id}` - 删除角色
- `POST /sys/role/page` - 分页查询角色
- `POST /sys/role/assignMenu` - 分配菜单权限

#### 用户管理
- `POST /sys/user/add` - 新增用户
- `POST /sys/user/update` - 更新用户
- `DELETE /sys/user/delete/{id}` - 删除用户
- `POST /sys/user/page` - 分页查询用户
- `POST /sys/user/assignRole` - 分配角色

#### 数据字典管理
- `POST /sys/dictionary/add` - 新增字典
- `POST /sys/dictionary/update` - 更新字典
- `DELETE /sys/dictionary/delete/{id}` - 删除字典（级联删除子字典）
- `POST /sys/dictionary/page` - 分页查询字典
- `GET /sys/dictionary/getByKey/{key}` - 根据key获取字典树

---

## 二、商品库存模块 (mall-pms)

### 2.1 产品系统功能

#### 2.1.1 商品分类管理
- 分类的增删改查
- 多级分类树形结构
- 分类排序
- 分类启用/禁用

#### 2.1.2 品牌管理
- 品牌的增删改查
- 品牌logo上传
- 品牌排序
- 品牌启用/禁用

#### 2.1.3 商品属性管理
- 商品属性定义（规格属性、参数属性）
- 属性值管理
- 属性与分类关联

#### 2.1.4 商品管理
- 商品基本信息管理（SPU）
- 商品SKU管理（多规格商品）
- 商品上下架
- 商品审核流程
- 商品搜索（Elasticsearch）

#### 2.1.5 商品详情
- 商品详情页展示
- 商品图片管理
- 商品描述管理

### 2.2 库存系统功能

#### 2.2.1 库存管理
- 库存查询
- 库存锁定（下单时）
- 库存扣减（支付成功后）
- 库存释放（订单取消/超时）
- 库存预警（低库存提醒）

#### 2.2.2 库存记录
- 库存变动记录
- 出入库记录
- 库存变动原因记录

### 2.3 数据流转流程

#### 2.3.1 商品上架流程
```
创建商品SPU → 设置商品属性 → 创建商品SKU → 设置库存 → 提交审核 → 审核通过 → 商品上架 → 同步到ES
```

#### 2.3.2 库存锁定流程
```
订单创建 → 调用库存服务 → 检查库存是否充足 → 锁定库存 → 返回锁定结果 → 记录库存锁定记录
```

#### 2.3.3 库存扣减流程
```
支付成功 → 调用库存服务 → 扣减锁定库存 → 更新库存数量 → 记录库存扣减记录
```

#### 2.3.4 库存释放流程
```
订单取消/超时 → 调用库存服务 → 释放锁定库存 → 更新库存数量 → 记录库存释放记录
```

### 2.4 数据库表设计

#### pms_category (商品分类表)
- id: 主键
- parent_id: 父分类ID
- category_name: 分类名称
- category_level: 分类级别
- sort_order: 排序
- status: 状态

#### pms_brand (品牌表)
- id: 主键
- brand_name: 品牌名称
- brand_logo: 品牌logo
- sort_order: 排序
- status: 状态

#### pms_attribute (商品属性表)
- id: 主键
- attribute_name: 属性名称
- attribute_type: 属性类型（规格/参数）
- category_id: 分类ID
- input_type: 输入类型（单选/多选/文本）

#### pms_attribute_value (属性值表)
- id: 主键
- attribute_id: 属性ID
- attribute_value: 属性值
- sort_order: 排序

#### pms_product (商品SPU表)
- id: 主键
- product_name: 商品名称
- category_id: 分类ID
- brand_id: 品牌ID
- product_price: 商品价格
- product_images: 商品图片
- product_desc: 商品描述
- publish_status: 上架状态
- verify_status: 审核状态

#### pms_sku (商品SKU表)
- id: 主键
- product_id: 商品SPU ID
- sku_code: SKU编码
- sku_attributes: SKU属性（JSON格式）
- sku_price: SKU价格
- sku_images: SKU图片
- stock_id: 库存ID（关联库存表）

#### pms_stock (库存表)
- id: 主键
- product_id: 商品ID
- sku_id: SKU ID
- total_stock: 总库存
- available_stock: 可用库存
- locked_stock: 锁定库存
- warehouse_id: 仓库ID（暂为0，单仓库）

#### pms_stock_lock (库存锁定表)
- id: 主键
- stock_id: 库存ID
- order_id: 订单ID
- lock_quantity: 锁定数量
- lock_status: 锁定状态（锁定/已扣减/已释放）
- lock_time: 锁定时间
- expire_time: 过期时间

#### pms_stock_record (库存变动记录表)
- id: 主键
- stock_id: 库存ID
- change_type: 变动类型（锁定/扣减/释放/入库/出库）
- change_quantity: 变动数量
- before_stock: 变动前库存
- after_stock: 变动后库存
- order_id: 订单ID（如有）
- remark: 备注

### 2.5 接口设计

#### 商品分类管理
- `POST /pms/category/add` - 新增分类
- `POST /pms/category/update` - 更新分类
- `DELETE /pms/category/delete/{id}` - 删除分类
- `POST /pms/category/page` - 分页查询分类
- `GET /pms/category/tree` - 获取分类树

#### 品牌管理
- `POST /pms/brand/add` - 新增品牌
- `POST /pms/brand/update` - 更新品牌
- `DELETE /pms/brand/delete/{id}` - 删除品牌
- `POST /pms/brand/page` - 分页查询品牌

#### 商品管理
- `POST /pms/product/add` - 新增商品
- `POST /pms/product/update` - 更新商品
- `DELETE /pms/product/delete/{id}` - 删除商品
- `POST /pms/product/page` - 分页查询商品
- `GET /pms/product/detail/{id}` - 获取商品详情
- `POST /pms/product/publish/{id}` - 商品上架
- `POST /pms/product/delisting/{id}` - 商品下架
- `POST /pms/product/search` - 商品搜索（ES）

#### SKU管理
- `POST /pms/sku/add` - 新增SKU
- `POST /pms/sku/update` - 更新SKU
- `DELETE /pms/sku/delete/{id}` - 删除SKU
- `GET /pms/sku/list/{productId}` - 获取商品SKU列表

#### 库存管理
- `GET /pms/stock/get/{skuId}` - 获取库存信息
- `POST /pms/stock/lock` - 锁定库存（内部接口）
- `POST /pms/stock/deduct` - 扣减库存（内部接口）
- `POST /pms/stock/release` - 释放库存（内部接口）
- `POST /pms/stock/record/page` - 分页查询库存记录

---

## 三、订单管理模块 (mall-oms)

### 3.1 订单系统功能

#### 3.1.1 订单创建
- 从购物车创建订单
- 订单信息填写（收货地址、备注等）
- 订单金额计算
- 库存锁定

#### 3.1.2 订单查询
- 用户订单列表查询
- 管理员订单列表查询
- 订单详情查询
- 订单状态查询

#### 3.1.3 订单状态管理
- 订单状态流转（待付款→待发货→已发货→已完成）
- 订单取消（仅待付款状态可取消）
- 订单超时自动取消（定时任务）

#### 3.1.4 订单支付
- 假支付处理
- 支付状态更新
- 支付接口预留（后续扩展真实支付）

### 3.2 数据流转流程

#### 3.2.1 订单创建流程
```
用户选择商品 → 加入购物车 → 结算购物车 → 选择收货地址 → 创建订单 → 锁定库存 → 返回订单信息
```

#### 3.2.2 订单支付流程
```
用户选择支付 → 调用支付服务 → 假支付处理 → 更新订单状态为已支付 → 扣减库存 → 返回支付结果
```

#### 3.2.3 订单取消流程
```
用户取消订单/订单超时 → 检查订单状态 → 更新订单状态为已取消 → 释放锁定库存 → 返回取消结果
```

#### 3.2.4 订单状态流转流程
```
待付款 → (支付) → 待发货 → (发货) → 已发货 → (确认收货) → 已完成
待付款 → (取消/超时) → 已取消
```

### 3.3 数据库表设计

#### oms_order (订单主表)
- id: 主键
- order_code: 订单编号
- user_id: 用户ID
- order_status: 订单状态（0待付款/1待发货/2已发货/4已完成/5已取消）
- order_type: 订单类型（0正常订单）
- total_amount: 订单总金额
- pay_amount: 实付金额
- pay_type: 支付方式（0未支付/1假支付）
- pay_time: 支付时间
- receiver_name: 收货人姓名
- receiver_phone: 收货人电话
- receiver_address: 收货地址
- remark: 订单备注
- create_time: 创建时间
- expire_time: 过期时间（待付款订单）

#### oms_order_item (订单项表)
- id: 主键
- order_id: 订单ID
- product_id: 商品ID
- sku_id: SKU ID
- product_name: 商品名称
- sku_attributes: SKU属性
- product_price: 商品单价
- product_quantity: 商品数量
- total_price: 小计金额

#### oms_order_status_log (订单状态日志表)
- id: 主键
- order_id: 订单ID
- order_status: 订单状态
- status_desc: 状态描述
- operator: 操作人
- create_time: 创建时间

### 3.4 接口设计

#### 订单管理
- `POST /oms/order/create` - 创建订单
- `POST /oms/order/page` - 分页查询订单
- `GET /oms/order/detail/{id}` - 获取订单详情
- `POST /oms/order/cancel/{id}` - 取消订单
- `POST /oms/order/pay/{id}` - 支付订单（假支付）

#### 订单管理（管理员）
- `POST /oms/order/mgr/page` - 管理员分页查询订单
- `GET /oms/order/mgr/detail/{id}` - 管理员获取订单详情
- `POST /oms/order/mgr/ship/{id}` - 订单发货

---

## 四、用户系统 (mall-ums)

### 4.1 功能模块

#### 4.1.1 用户注册登录
- 用户注册（手机号/邮箱注册）
- 用户登录（对接mall-auth）
- 用户登出
- 密码重置

#### 4.1.2 用户信息管理
- 用户基本信息查询
- 用户信息修改
- 头像上传
- 密码修改

#### 4.1.3 收货地址管理
- 收货地址新增
- 收货地址修改
- 收货地址删除
- 收货地址列表查询
- 设置默认地址

### 4.2 数据流转流程

#### 4.2.1 用户注册流程
```
用户填写注册信息 → 验证手机号/邮箱 → 创建用户账号 → 返回注册结果
```

#### 4.2.2 用户登录流程
```
用户提交登录信息 → 调用认证服务 → 验证用户名密码 → 生成Token → 返回Token
```

#### 4.2.3 收货地址管理流程
```
用户新增地址 → 验证地址信息 → 保存地址 → 返回地址信息
用户设置默认地址 → 取消原默认地址 → 设置新默认地址
```

### 4.3 数据库表设计

#### ums_user (用户表)
- id: 主键
- username: 用户名
- password: 密码（加密）
- nickname: 昵称
- phone: 手机号
- email: 邮箱
- avatar: 头像
- gender: 性别
- birthday: 生日
- status: 状态（0正常/1禁用）

#### ums_address (收货地址表)
- id: 主键
- user_id: 用户ID
- receiver_name: 收货人姓名
- receiver_phone: 收货人电话
- province: 省份
- city: 城市
- district: 区县
- detail_address: 详细地址
- postal_code: 邮编
- is_default: 是否默认地址（0否/1是）

### 4.4 接口设计

#### 用户管理
- `POST /ums/user/register` - 用户注册
- `POST /ums/user/login` - 用户登录（对接auth服务）
- `POST /ums/user/logout` - 用户登出
- `GET /ums/user/info` - 获取用户信息
- `POST /ums/user/update` - 更新用户信息
- `POST /ums/user/changePassword` - 修改密码

#### 收货地址管理
- `POST /ums/address/add` - 新增收货地址
- `POST /ums/address/update` - 更新收货地址
- `DELETE /ums/address/delete/{id}` - 删除收货地址
- `GET /ums/address/list` - 获取收货地址列表
- `POST /ums/address/setDefault/{id}` - 设置默认地址

---

## 五、购物车系统 (mall-cart)

### 5.1 功能模块

#### 5.1.1 购物车管理
- 添加商品到购物车
- 修改购物车商品数量
- 删除购物车商品
- 清空购物车
- 购物车列表查询

#### 5.1.2 购物车结算
- 选择购物车商品
- 计算购物车总金额
- 跳转到订单创建页面

### 5.2 数据流转流程

#### 5.2.1 添加商品到购物车流程
```
用户选择商品 → 选择SKU和数量 → 检查库存 → 添加到购物车 → 返回购物车信息
```

#### 5.2.2 购物车结算流程
```
用户选择购物车商品 → 验证商品库存 → 计算总金额 → 跳转订单创建页面
```

#### 5.2.3 购物车同步流程
```
用户登录 → 合并未登录时的购物车数据 → 同步到数据库 → 返回购物车列表
```

### 5.3 数据库表设计

#### cart_cart (购物车表)
- id: 主键
- user_id: 用户ID
- product_id: 商品ID
- sku_id: SKU ID
- product_name: 商品名称
- sku_attributes: SKU属性
- product_price: 商品单价
- product_quantity: 商品数量
- product_image: 商品图片
- create_time: 创建时间
- update_time: 更新时间

### 5.4 接口设计

#### 购物车管理
- `POST /cart/add` - 添加商品到购物车
- `POST /cart/update` - 更新购物车商品数量
- `DELETE /cart/delete/{id}` - 删除购物车商品
- `POST /cart/clear` - 清空购物车
- `GET /cart/list` - 获取购物车列表
- `POST /cart/settle` - 购物车结算（返回结算信息）

---

## 六、支付系统 (mall-pay)

### 6.1 功能模块

#### 6.1.1 假支付处理
- 模拟支付成功
- 更新订单支付状态
- 记录支付交易

#### 6.1.2 支付接口预留
- 定义支付接口规范（IPaymentService）
- 预留支付方式枚举（支付宝、微信等）
- 预留支付回调接口

### 6.2 数据流转流程

#### 6.2.1 假支付流程
```
用户选择支付 → 调用支付服务 → 模拟支付成功 → 更新订单状态 → 记录支付交易 → 返回支付结果
```

#### 6.2.2 支付回调流程（预留）
```
真实支付回调 → 验证回调签名 → 更新订单状态 → 记录支付交易 → 返回处理结果
```

### 6.3 数据库表设计

#### pay_transaction (支付交易表)
- id: 主键
- order_id: 订单ID
- order_code: 订单编号
- pay_type: 支付方式（0假支付/1支付宝/2微信）
- pay_amount: 支付金额
- pay_status: 支付状态（0待支付/1支付成功/2支付失败）
- transaction_no: 交易流水号
- pay_time: 支付时间
- remark: 备注

### 6.4 接口设计

#### 支付管理
- `POST /pay/pay` - 支付订单（假支付）
- `GET /pay/query/{orderId}` - 查询支付状态
- `POST /pay/callback` - 支付回调（预留接口，后续真实支付使用）

---

## 七、系统间调用关系

### 7.1 服务调用流程图

```
用户请求
  ↓
Gateway (网关)
  ↓
Auth服务 (认证授权)
  ↓
业务服务
  ├── 用户服务 (mall-ums)
  │     └── 调用 Auth服务
  │
  ├── 商品服务 (mall-pms)
  │     └── 内部处理（商品+库存）
  │
  ├── 购物车服务 (mall-cart)
  │     ├── 调用 用户服务
  │     └── 调用 商品服务
  │
  ├── 订单服务 (mall-oms)
  │     ├── 调用 用户服务
  │     ├── 调用 商品服务（库存锁定/扣减/释放）
  │     └── 调用 购物车服务
  │
  └── 支付服务 (mall-pay)
        └── 调用 订单服务
```

### 7.2 关键业务流程

#### 7.2.1 完整购物流程
```
1. 用户浏览商品（商品服务）
2. 用户添加商品到购物车（购物车服务 → 商品服务验证库存）
3. 用户结算购物车（购物车服务 → 商品服务验证库存）
4. 用户创建订单（订单服务 → 商品服务锁定库存 → 购物车服务清空选中商品）
5. 用户支付订单（支付服务 → 订单服务更新状态 → 商品服务扣减库存）
6. 订单发货（订单服务更新状态）
7. 订单完成（订单服务更新状态）
```

#### 7.2.2 订单取消流程
```
1. 用户取消订单/订单超时（订单服务）
2. 订单服务调用商品服务释放库存
3. 更新订单状态为已取消
```

---

## 八、技术实现要点

### 8.1 分布式事务处理

#### 订单创建 + 库存锁定
- 使用Seata AT模式
- 订单服务和商品服务参与分布式事务
- 保证订单创建和库存锁定的一致性

#### 支付成功 + 库存扣减
- 使用Seata AT模式
- 支付服务和商品服务参与分布式事务
- 保证支付成功和库存扣减的一致性

### 8.2 库存并发控制

#### 库存锁定/扣减
- 使用Redis分布式锁
- 锁的key：`stock:lock:{skuId}`
- 锁的超时时间：30分钟（订单超时时间）

#### 库存双重校验
- 下单时校验库存
- 支付时再次校验库存
- 防止超卖

### 8.3 缓存策略

#### 商品详情缓存
- Redis缓存：商品基本信息、SKU信息
- 缓存key：`product:detail:{productId}`
- 缓存时间：1小时

#### 库存信息缓存
- Redis缓存：可用库存数量
- 缓存key：`stock:available:{skuId}`
- 缓存时间：5分钟
- 库存变动时更新缓存

#### 购物车缓存
- Redis缓存：未登录用户的购物车
- 缓存key：`cart:guest:{sessionId}`
- 用户登录后同步到数据库

### 8.4 定时任务

#### 订单超时自动取消
- 任务频率：每5分钟执行一次
- 扫描条件：订单状态=待付款 && 创建时间超过30分钟
- 执行操作：取消订单 + 释放库存

---

**文档版本**：1.0
**编写日期**：2025-12-20
**说明**：本文档为详细设计文档，包含各子系统的功能、流程、数据库表和接口设计。数据库表和接口设计仅包含核心字段，后续可自行补充完善。



