# 业务服务改造示例

## 说明

当网关层完成认证和权限校验后，业务服务需要移除或禁用原有的认证拦截器，避免重复校验。

## 改造方式

### 方式1：条件禁用（推荐）

在 `SaTokenConfigure` 配置类上添加条件注解，当网关启用认证时自动禁用业务服务的认证拦截器：

```java
package com.yz.mall.auth;

import cn.dev33.satoken.interceptor.SaInterceptor;
import cn.dev33.satoken.router.SaRouter;
import cn.dev33.satoken.stp.StpUtil;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

/**
 * @author yunze
 * @date 2024/11/15 星期五 21:44
 */
@Slf4j
@Configuration
@ConditionalOnProperty(name = "gateway.auth.enabled", havingValue = "false", matchIfMissing = true)
public class SaTokenConfigure implements WebMvcConfigurer {
    // 注册 Sa-Token 拦截器，打开注解式鉴权功能
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        // 注册 Sa-Token 拦截器，打开注解式鉴权功能
        registry.addInterceptor(new SaInterceptor(handle -> {
                log.warn("进入SaInterceptor拦截: {}", this.getClass());
            SaRouter.match("/**")
                    // "/beat", "/idleBeat", "/kill", "/run", "/log"为xxljob所需接口
                    .notMatch("/extend/**", "/sys/test/*"
                            , "/beat", "/idleBeat", "/kill", "/run", "/log"
                            , "/error/**"
                            , "/actuator/**")
                    .check(r -> StpUtil.checkLogin());
        })).addPathPatterns("/**");
    }
}
```

**说明**：
- `matchIfMissing = true`：如果配置不存在，默认启用（向后兼容）
- 当 `gateway.auth.enabled=false` 时，业务服务的认证拦截器才会生效
- 当网关启用认证时，业务服务的认证拦截器自动禁用

### 方式2：完全移除

如果确定所有请求都通过网关，可以直接移除 `SaTokenConfigure` 配置类。

### 方式3：注释代码

临时禁用认证拦截器，保留代码以便回滚：

```java
@Slf4j
@Configuration
public class SaTokenConfigure implements WebMvcConfigurer {
    // 网关层已实现认证，业务服务不再需要认证拦截器
    // @Override
    // public void addInterceptors(InterceptorRegistry registry) {
    //     ...
    // }
}
```

## 获取用户信息

业务服务可以通过请求头获取网关传递的用户ID：

### Controller 方式

```java
@RestController
@RequestMapping("sys/dictionary")
public class SysDictionaryController {
    
    @PostMapping("add")
    public Result<Long> insert(
            @RequestBody @Valid SysDictionaryAddDto dto,
            @RequestHeader(value = "X-User-Id", required = false) String userId) {
        // 使用 userId
        log.info("当前操作用户ID: {}", userId);
        return success(this.service.save(dto));
    }
}
```

### 工具类方式

创建工具类从请求上下文中获取用户ID：

```java
package com.yz.mall.base.util;

import jakarta.servlet.http.HttpServletRequest;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;

public class UserContextUtil {
    
    /**
     * 获取当前用户ID（从网关传递的请求头中获取）
     */
    public static String getCurrentUserId() {
        ServletRequestAttributes attributes = 
            (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        if (attributes != null) {
            HttpServletRequest request = attributes.getRequest();
            return request.getHeader("X-User-Id");
        }
        return null;
    }
    
    /**
     * 获取当前用户ID（Long类型）
     */
    public static Long getCurrentUserIdAsLong() {
        String userId = getCurrentUserId();
        return userId != null ? Long.parseLong(userId) : null;
    }
}
```

## 权限注解处理

### 选项1：保留注解（推荐）

保留 `@SaCheckPermission` 注解，但业务服务不再进行权限校验：
- 注解可以用于文档生成
- 便于后续回滚
- 网关层已经进行了权限校验

```java
@SaCheckPermission("api:system:dictionary:update")
@PostMapping("add")
public Result<Long> insert(@RequestBody @Valid SysDictionaryAddDto dto) {
    // 网关层已进行权限校验，这里直接执行业务逻辑
    return success(this.service.save(dto));
}
```

### 选项2：移除注解

如果确定不再需要，可以移除所有 `@SaCheckPermission` 注解。

## 配置示例

在业务服务的 `application.yaml` 中配置：

```yaml
# 网关认证配置
gateway:
  auth:
    # 设置为 false 表示业务服务自己处理认证（向后兼容）
    # 设置为 true 或不配置，表示由网关处理认证
    enabled: false  # 仅在需要业务服务自己处理认证时设置为 false
```

## 迁移检查清单

- [ ] 更新 `SaTokenConfigure` 配置类，添加条件注解
- [ ] 测试认证功能是否正常
- [ ] 测试权限校验是否正常
- [ ] 验证用户信息获取是否正常
- [ ] 检查日志，确认没有重复认证
- [ ] 性能测试，确认响应时间正常
- [ ] 更新相关文档

## 注意事项

1. **灰度发布**：建议先在一个业务服务上测试，确认无误后再推广到其他服务
2. **回滚准备**：保留原有代码，确保可以快速回滚
3. **监控告警**：迁移后密切关注认证失败率和性能指标
4. **文档更新**：更新 API 文档，说明认证由网关统一处理

