# 权限映射扫描机制说明

## 概述

实现了基于注解扫描的权限标识获取机制，业务服务在启动时自动扫描所有Controller接口，解析`@SaCheckPermission`注解，将接口URI和权限标识的映射关系存储到Redis，网关层从Redis获取权限标识进行校验。

## 实现原理

### 1. 业务服务启动时扫描

**组件：PermissionMappingScanner**

- 监听 `ApplicationReadyEvent` 事件，在应用启动完成后执行扫描
- 扫描所有带有 `@RestController` 或 `@Controller` 注解的Bean
- 解析每个Controller方法上的 `@SaCheckPermission` 注解
- 构建完整的接口URI（Controller的`@RequestMapping` + 方法的请求映射）
- 将URI和权限标识的映射关系存储到Redis

**Redis存储格式：**
```
Key: permission:api-mapping:服务名:URI
Value: 权限标识

示例：
Key: permission:api-mapping:mall-sys:/sys/dictionary/add
Value: api:system:dictionary:update
```

### 2. 网关层权限校验

**组件：GatewayPermissionService**

- 根据请求路径从Redis查找对应的权限标识
- 支持精确匹配和路径匹配（通配符）
- 使用本地缓存提升性能
- 如果Redis中未找到，说明该接口不需要权限校验

## 核心组件

### 1. PermissionMappingScanner

**位置：** `mall-auth/mall-auth-interface/src/main/java/com/yz/mall/auth/scanner/PermissionMappingScanner.java`

**功能：**
- 扫描所有Controller接口
- 解析`@SaCheckPermission`注解
- 构建URI-权限映射
- 存储到Redis

**关键方法：**
- `onApplicationEvent()` - 应用启动时触发扫描
- `scanControllers()` - 扫描所有Controller
- `getMethodPath()` - 获取方法的请求路径
- `buildFullUri()` - 构建完整URI
- `saveToRedis()` - 保存到Redis

### 2. GatewayPermissionService

**位置：** `mall-gateway/src/main/java/com/yz/mall/gateway/service/GatewayPermissionService.java`

**功能：**
- 从Redis获取接口权限映射
- 支持本地缓存
- 路径匹配（支持通配符）

**关键方法：**
- `getRequiredPermission()` - 根据路径获取权限标识
- `findInRedis()` - 从Redis查找权限映射
- `findInCache()` - 从本地缓存查找
- `normalizePath()` - 规范化路径

### 3. RedisCacheKey

**位置：** `mall-utils/mall-redis/src/main/java/com/yz/mall/redis/RedisCacheKey.java`

**新增方法：**
- `apiPermissionMapping(serviceName, uri)` - 获取权限映射的Redis Key
- `apiPermissionMappingPattern(serviceName)` - 获取匹配模式

## 工作流程

```
1. 业务服务启动
   ↓
2. PermissionMappingScanner 监听 ApplicationReadyEvent
   ↓
3. 扫描所有Controller接口
   ↓
4. 解析 @SaCheckPermission 注解
   ↓
5. 构建 URI-权限映射关系
   ↓
6. 存储到Redis（格式：permission:api-mapping:服务名:URI）
   ↓
7. 网关接收请求
   ↓
8. GatewayPermissionService 根据路径从Redis查找权限标识
   ↓
9. 进行权限校验
```

## 优势

1. **准确性高**：直接从注解获取权限标识，不会推断错误
2. **自动化**：业务服务启动时自动扫描，无需手动配置
3. **灵活性好**：支持复杂的权限标识，不受路径规则限制
4. **易维护**：权限标识变更时，重启服务即可自动更新
5. **性能优化**：网关层使用本地缓存，减少Redis查询

## 注意事项

### 1. 服务名称配置

确保业务服务的 `spring.application.name` 配置正确，用于区分不同服务的权限映射：

```yaml
spring:
  application:
    name: mall-sys  # 服务名称
```

### 2. Redis连接

业务服务和网关都需要能够访问同一个Redis实例，确保权限映射数据共享。

### 3. 路径匹配

- 支持精确匹配：`/sys/dictionary/add`
- 支持通配符匹配：`/sys/dictionary/**`
- 路径规范化：自动处理查询参数、末尾斜杠等

### 4. 多权限支持

如果接口有多个权限标识（`@SaCheckPermission`的value是数组），目前只取第一个。如需支持多权限，可以扩展实现。

### 5. 动态更新

如果接口权限变更，需要重启业务服务才能更新Redis中的权限映射。后续可以考虑实现动态刷新机制。

## 测试验证

### 1. 验证权限映射扫描

启动业务服务后，检查Redis中是否有权限映射数据：

```bash
# 查看所有权限映射
redis-cli KEYS "permission:api-mapping:*"

# 查看特定服务的权限映射
redis-cli KEYS "permission:api-mapping:mall-sys:*"

# 查看具体接口的权限映射
redis-cli GET "permission:api-mapping:mall-sys:/sys/dictionary/add"
```

### 2. 验证网关权限校验

- 有权限的接口：正常访问
- 无权限的接口：返回403错误
- 未配置权限的接口：跳过权限校验（如果网关配置允许）

### 3. 日志检查

查看业务服务启动日志，确认扫描结果：

```
开始扫描服务 [mall-sys] 的Controller接口权限映射...
扫描到权限映射 - URI: /sys/dictionary/add, 权限: api:system:dictionary:update
服务 [mall-sys] 权限映射扫描完成，共扫描到 50 个接口权限映射
```

查看网关日志，确认权限校验过程：

```
从Redis找到权限映射 - 路径: /sys/dictionary/add, 权限: api:system:dictionary:update, 服务: mall-sys
网关权限校验通过 - 路径: /sys/dictionary/add, 权限: api:system:dictionary:update
```

## 故障排查

### 1. 权限映射未扫描到

- 检查Controller是否有`@RestController`或`@Controller`注解
- 检查方法是否有`@SaCheckPermission`注解
- 检查服务名称配置是否正确
- 查看启动日志是否有错误信息

### 2. 网关找不到权限映射

- 检查Redis连接是否正常
- 检查Redis中是否有对应服务的权限映射数据
- 检查路径是否匹配（注意路径规范化）
- 查看网关日志的详细错误信息

### 3. 权限校验失败

- 检查用户是否有对应权限
- 检查权限标识是否匹配
- 检查Redis中的权限数据是否正确

## 后续优化

1. **多权限支持**：支持接口配置多个权限标识，满足"或"关系的权限校验
2. **动态刷新**：实现权限映射的动态刷新机制，无需重启服务
3. **权限映射管理**：提供管理接口，查看和管理所有接口的权限映射
4. **性能优化**：优化Redis查询，使用批量操作提升性能
5. **监控告警**：添加权限映射扫描和校验的监控指标

